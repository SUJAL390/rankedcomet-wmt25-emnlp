# rankedCOMET â€“ WMT 2025 QE Submission

This repository contains the full rankedCOMET system described in the WMT 2025 Task 1 Quality Estimation sprint paper. It packages the inference notebook, calibration scripts, diagnostics, figures, and ablations required to reproduce the reported results and analyses.

## ğŸš€ Quick start

1. **Clone the repo**
	```bash
	git clone https://github.com/SUJAL390/rankedcomet-wmt25-emnlp.git
	cd rankedcomet-wmt25-emnlp
	```
2. **Create a Python environment (â‰¥3.9 recommended)**
	```bash
	python -m venv .venv
	.venv\Scripts\activate  # PowerShell
	```
3. **Install dependencies**
	```bash
	pip install -r requirements.txt
	```
4. **Stage required data**
	Place the following files in the repository root (not distributed here):
	- `mteval-task1-test25.tsv.gz` â€“ official WMT2025 Task 1 test set.
	- `raw_scores_backup.pkl` â€“ cached COMET raw scores (generated by the notebook below).

> **Hardware note:** COMET inference benefits from a CUDA-capable GPU. All remaining scripts are CPU-friendly.

## ğŸ“ Repository structure

```
.
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ wmt25-task1-qualityprediction-sprint2.ipynb   # COMET inference + submission writer
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ calibrate_scores.py                           # Per-language rankâ†’minâ€“max calibration
â”‚   â”œâ”€â”€ final_gambit.py                               # Negative ensemble experiment
â”‚   â”œâ”€â”€ compare_raw_ranked.py                         # Raw vs ranked correlation diagnostics
â”‚   â”œâ”€â”€ analysis_per_language.py                      # Pearson/Spearman/Kendall + bootstrap CIs
â”‚   â”œâ”€â”€ rankedcomet_full_analysis.py                  # Variance analysis, dev mapping, ablations
â”‚   â”œâ”€â”€ rankedcomet_figures.py                        # Figures A/B/C from the paper
â”‚   â””â”€â”€ create_variance_plot.py                       # Camera-ready variance scatter
â”œâ”€â”€ figures_camera_ready/                             # Publication-ready figures
â”œâ”€â”€ figures1/                                         # Intermediate diagnostic figures
â”œâ”€â”€ results_all/                                      # CSV outputs (variance, ablation, etc.)
â”œâ”€â”€ segments.tsv                                      # Ranked submission (produced by calibration)
â”œâ”€â”€ raw_scores_backup.pkl                             # Cached COMET raw scores (not versioned)
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## ğŸ§­ Reproduction workflow

1. **Generate raw COMET scores**
	- Open `notebooks/wmt25-task1-qualityprediction-sprint2.ipynb` in VS Code or Jupyter.
	- Update the paths if your test file is stored elsewhere.
	- Run all cells to create `segments.tsv` and cache raw scores into `raw_scores_backup.pkl`.

2. **Per-language calibration (rankedCOMET)**
	```bash
	python scripts/calibrate_scores.py
	```
	- Produces `segments_ranked_final_v2.tsv`, the calibrated submission described in the paper.

3. **Negative ensemble attempt** (optional, reported as negative result)
	```bash
	python scripts/final_gambit.py
	```

4. **Raw vs ranked diagnostics**
	```bash
	python scripts/compare_raw_ranked.py segments_ranked_final_v2.tsv raw_scores_backup.pkl
	```
	- Outputs `raw_vs_ranked_stats.csv` used in Table 3 / Figure 2.

5. **Variance analysis, dev-based mapping, and ablations**
	```bash
	# Variance analysis (writes results_all/var_analysis/*)
	python scripts/rankedcomet_full_analysis.py variance-analysis \
		 --test segments_ranked_final_v2.tsv \
		 --raw raw_scores_backup.pkl \
		 --outdir results_all/var_analysis

	# Dev-calibration (optional; requires dev files)
	python scripts/rankedcomet_full_analysis.py dev-calibrate \
		 --dev_tsv DEV_SEGMENTS.tsv \
		 --dev_raw DEV_RAW.pkl \
		 --test_tsv mteval-task1-test25.tsv \
		 --test_raw raw_scores_backup.pkl \
		 --out_prefix devmap \
		 --outdir results_all/dev_calibrate

	# Ablation suite
	python scripts/rankedcomet_full_analysis.py ablation \
		 --test segments_ranked_final_v2.tsv \
		 --raw raw_scores_backup.pkl \
		 --outdir results_all/ablation
	```

6. **Figures**
	```bash
	python scripts/create_variance_plot.py \
		 --test-tsv segments_ranked_final_v2.tsv \
		 --raw-pkl raw_scores_backup.pkl \
		 --output figures_camera_ready/var_rank_vs_var_raw_final.png

	python scripts/rankedcomet_figures.py --fig-delta-var --fig-hist --fig-ties \
		 --segments segments_ranked_final_v2.tsv \
		 --raw raw_scores_backup.pkl \
		 --outdir figures_camera_ready
	```

7. **Per-language correlation tables**
	```bash
	python scripts/analysis_per_language.py segments_ranked_final_v2.tsv --bootstrap 2000
	```
	- Produces `per_language_correlations.csv`, `per_language_pearson_bootstrap.csv`, and `aggregated_results.csv`.

## ğŸ§ª Mapping outputs to paper artifacts

| Paper artifact | How to reproduce |
| --- | --- |
| Ranked submission file | `scripts/calibrate_scores.py` â†’ `segments_ranked_final_v2.tsv` |
| Table 1 snapshot (Codabench) | Provided for context â€“ generated externally (Codabench UI) |
| Table 2 (variance diagnostics) | `rankedcomet_full_analysis.py variance-analysis` |
| Table 3 (raw vs ranked correlations) | `compare_raw_ranked.py` |
| Table 4 (ablations) | `rankedcomet_full_analysis.py ablation` |
| Figure 1 | `create_variance_plot.py` |
| Figure 2 & Figure 3 | `rankedcomet_figures.py` |

## ğŸ“¦ Dataset availability

- **Test set (`mteval-task1-test25.tsv.gz`)** â€“ distributed by the WMT 2025 QE task organizers on Codabench. Obtain it under the shared task rules.
- **Dev set** â€“ optional for dev-based calibration; follow WMT data usage guidelines.
- **Human annotations** â€“ required for running `analysis_per_language.py`. Provide a TSV with either `human`, `mqm`, or equivalent column as described in the script help message.

## âš ï¸ Limitations

- The reported leaderboard position references the preliminary Codabench snapshot. Final official rankings may differ.
- Rank-based calibration cannot recover signal for language pairs where the base COMET model has none (e.g., ENâ€“AR/ENâ€“BHO in our experiments).
- When test-set statistics are disallowed, rely on the dev-based mapping provided in the scripts.

